<template>
  <div class="top">
    <div class="container mx-auto px-4">
      <div class="flex mb-4">
        <div class="w-1/4">
          <router-link to="/personchange">
            <div>
              <p class="heading">{{ name }}</p>
              <div class="item-image">
                <img :src="image" width="60" height="60">
              </div>
            </div>
          </router-link>
        </div>

        <div class="w-1/4">
          <router-link to="/list">
            <p class="heading">楽曲エントリー</p>
            <p class="title">
              <i class="fas fa-play is-size-4"></i>
            </p>
          </router-link>
        </div>

        <div class="w-1/4">
          <div>
            <p class="heading">
              <i class="far fa-thumbs-up">いいね！</i>
            </p>
            <transition mode="out-in" name="bounce">
              <p class="title" v-if="show" :key="getapt">{{getapt}}</p>
            </transition>
          </div>
        </div>

        <div class="w-1/4">
          <div>
            <p class="heading">残りポイント</p>
            <p class="title">{{apt}}</p>
          </div>
        </div>
      </div>

      <div
        style="height:300px; width:100%; overflow-y:auto; background-color:#FFFFFF; text-align:left; padding:10px; border-radius: 3px;"
      >
        <li class="text-base" v-for="item in board" style="list-style: none;">
          <a class="item-image" @click="isImageModalActive = true">
            <img :src="item.image" width="40" height="40">
          </a>
          <B>{{item.name}} :</B>
          <a v-html="item.messege">{{item.messege}}</a>
        </li>
      </div>

      <div style="height:20px;"></div>

      <multiselect
        v-model="selected"
        deselect-label="一人を選んでください。"
        track-by="uid"
        label="name"
        placeholder="誰にいいねしますか？"
        :options="options"
        :searchable="true"
        :allow-empty="false"
        :show-labels="false"
      ></multiselect>

      <div style="height:20px;"></div>

      <div class="columns is-mobile">
        <div class="column">
          <a
            class="button is-danger is-large"
            v-bind:disabled="isButtonDisabled4"
            @click="sendMessage4"
          >
            <i class="far fa-thumbs-up is-size-2">いいね！</i>
          </a>
        </div>
      </div>

      <input class="input" type="text" placeholder="chat-いろんなコメントください!" v-model="messege">

      <div style="height:10px;"></div>
      <a class="button is-light" style="text-align: left;" @click="sendMessage5">送信</a>
      <div style="height:20px;"></div>

      <h6 class="is-size-7">
        <B>
          今日プレイした人たちに
          <i class="far fa-thumbs-up"></i>やメッセージを！
        </B>
      </h6>
      <div style="height:20px;"></div>

      <h6 class="is-size-7">
        <B>＜順番表＞</B>
      </h6>
      <div style="height:5px;"></div>
      <ul>
        <li
          class="is-size-7"
          v-for="item in flist"
          style="list-style: none; background-color:#FFFFFF; text-align:left; padding:10px; border-radius: 3px;"
        >
          <a class="item-image">
            <img :src="item.image" width="20" height="20">
          </a>
          <B>No.{{item.sessionOrder}}：</B>
          {{item.entune}} {{item.name}} {{item.stage}} {{item.player1}} {{item.player2}} {{item.player3}} {{item.player4}} {{item.player5}} {{item.player6}} {{item.player7}} {{item.player8}} {{item.player9}}
        </li>
      </ul>
      <h6 class="is-size-7">
        <B>Now</B>
      </h6>
      <ul>
        <li
          class="is-size-7"
          v-for="item in clist"
          style="list-style: none; background-color:#FFFFFF; text-align:left; padding:10px; border-radius: 3px;"
        >
          <a class="item-image">
            <img :src="item.image" width="20" height="20">
          </a>
          <B>No.{{item.sessionOrder}}：</B>
          {{item.entune}} {{item.name}} {{item.stage}} {{item.player1}} {{item.player2}} {{item.player3}} {{item.player4}} {{item.player5}} {{item.player6}} {{item.player7}} {{item.player8}} {{item.player9}}
        </li>
      </ul>
    </div>
  </div>
</template>


<script>
import firebase from "firebase";
import Multiselect from "vue-multiselect";
import InfiniteLoading from "vue-infinite-loading";

export default {
  name: "top",
  components: { Multiselect, InfiniteLoading },
  data() {
    return {
      list: [], // 最新状態はここにコピーされる
      name: "", // 名前
      image: "",
      sendp: null, // 送信メッセージ
      mslist: "",
      board: "",
      show: true,
      selected: null,
      options: [],
      apt: "",
      getapt: "",
      artistname: "",
      namelist: [],
      isButtonDisabled1: false,
      isButtonDisabled2: false,
      isButtonDisabled3: false,
      isButtonDisabled4: false,
      messege: "",
      finlist: [],
      clist: [],
      flist: [],
      isImageModalActive: false
    };
  },
  watch: {
    getapt: function(newValue) {}
  },

  created() {
    // 認証チェック

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        console.log("ログイン状態");
        this.listen();
      } else {
      }
    });
  },

  methods: {
    signOut: function() {
      firebase
        .auth()
        .signOut()
        .then(() => {
          alert("ログアウトします");
          this.$router.push("/signin");
        });
    },

    listen() {
      var useruid = firebase.auth().currentUser.uid;

      firebase
        .database()
        .ref("loginuser/" + useruid + "/name")
        .on("value", snapshot => {
          this.name = snapshot.val();
        });

      firebase
        .database()
        .ref("loginuser/" + useruid + "/image")
        .on("value", snapshot => {
          this.image = snapshot.val();
        });

      firebase
        .database()
        .ref("loginuser/" + useruid + "/apt")
        .on("value", snapshot => {
          this.apt = snapshot.val();
          if (this.apt > 0) {
            this.isButtonDisabled4 = false;
          }
        });

      firebase
        .database()
        .ref("loginuser/" + useruid + "/getapt")
        .on("value", snapshot => {
          this.getapt = snapshot.val();
        });

      firebase
        .database()
        .ref("myBoard/")
        .on("value", snapshot => {
          if (snapshot) {
            const rootList = snapshot.val();
            let list = [];

            Object.keys(rootList).forEach((val, key) => {
              list.push(rootList[val]);
            });
            this.board = list.reverse();
          }
        });

      firebase
        .database()
        .ref("loginuser/")
        .on("value", snapshot => {
          if (snapshot) {
            const rootList = snapshot.val();
            let list = [];
            let otherslist = [];
            let namelist = [];
            var artistname = this.name;

            Object.keys(rootList).forEach((val, key) => {
              list.push(rootList[val]);
            });

            list.some(function(v, i) {
              if (v.name == artistname) list.splice(i, 1);
            });

            var nlist = list.filter(function(element) {
              return element.status !== "";
            });

            this.options = nlist;

            list.filter(function(item, index) {
              namelist.push(item.name);
            });

            this.namelist = namelist;
          }
        });

      firebase
        .database()
        .ref("entryBoard/")
        .on("value", snapshot => {
          if (snapshot) {
            const srootList = snapshot.val();
            let slist = [];

            Object.keys(srootList).forEach((val, key) => {
              slist.push(srootList[val]);
            });

            var nlist = slist.filter(function(elem) {
              return elem.sessionOrder > 0;
            });

            var finlist = nlist.sort(function(a, b) {
              if (a.sessionOrder > b.sessionOrder) return 1;
              if (a.sessionOrder < b.sessionOrder) return -1;
              return 0;
            });

            this.finlist = finlist;

            var clist = finlist.filter(function(element) {
              return element.sessionStatus == "coming";
            });
            this.clist = clist;

            var flist = finlist.filter(function(element) {
              return element.sessionStatus == "finished";
            });
            this.flist = flist;
            this.plyor = flist.length;
          }

          this.toOrder = this.finlist.length;
        });
    },

    sendMessage() {
      var artistname = this.name;
      var useruid = firebase.auth().currentUser.uid;
      var toname = this.selected["name"];
      var touid = this.selected["uid"];
      var ap = 20;
      var np = 0;
      var wp = 0;
      var takeap = 0;
      var giveap = 0;

      firebase
        .database()
        .ref("loginuser/" + useruid + "/apt")
        .once("value", snapshot => {
          const nowapt = snapshot.val();
          np = nowapt - ap;
        });

      if (np < 0) {
        this.isButtonDisabled1 = true;
        alert("ポイントが足りません！");
      } else {
        firebase
          .database()
          .ref("loginuser/" + touid + "/getapt")
          .once("value", snapshot => {
            const newapt = snapshot.val();
            wp = newapt + ap;
          });

        firebase
          .database()
          .ref("loginuser/" + useruid)
          .update({
            apt: np
          });

        firebase
          .database()
          .ref("loginuser/" + touid)
          .update({
            getapt: wp
          });

        firebase
          .database()
          .ref("myBoard/")
          .push({
            image: this.image,
            name: artistname,
            sendp: ap,
            to: toname,
            messege: toname + "に" + '<i class="far fa-thumbs-up"></i>' + ap
          });
      }
    },

    sendMessage2() {
      var artistname = this.name;
      var useruid = firebase.auth().currentUser.uid;
      var toname = this.selected["name"];
      var touid = this.selected["uid"];
      var ap = 10;
      var np = 0;
      var wp = 0;
      var takeap = 0;
      var giveap = 0;

      firebase
        .database()
        .ref("loginuser/" + useruid + "/apt")
        .once("value", snapshot => {
          const nowapt = snapshot.val();
          np = nowapt - ap;
        });

      if (np < 0) {
        this.isButtonDisabled1 = true;
        this.isButtonDisabled2 = true;
        alert("ポイントが足りません！");
      } else {
        firebase
          .database()
          .ref("loginuser/" + touid + "/getapt")
          .once("value", snapshot => {
            const newapt = snapshot.val();
            wp = newapt + ap;
          });

        firebase
          .database()
          .ref("loginuser/" + useruid)
          .update({
            apt: np
          });

        firebase
          .database()
          .ref("loginuser/" + touid)
          .update({
            getapt: wp
          });

        firebase
          .database()
          .ref("myBoard/")
          .push({
            image: this.image,
            name: artistname,
            sendp: ap,
            to: toname,
            messege: toname + "に" + '<i class="far fa-thumbs-up"></i>' + ap
          });
      }
    },

    sendMessage3() {
      var artistname = this.name;
      var useruid = firebase.auth().currentUser.uid;
      var toname = this.selected["name"];
      var touid = this.selected["uid"];
      var ap = 5;
      var np = 0;
      var wp = 0;
      var takeap = 0;
      var giveap = 0;

      firebase
        .database()
        .ref("loginuser/" + useruid + "/apt")
        .once("value", snapshot => {
          const nowapt = snapshot.val();
          np = nowapt - ap;
        });

      if (np < 0) {
        this.isButtonDisabled1 = true;
        this.isButtonDisabled2 = true;
        this.isButtonDisabled3 = true;
        alert("ポイントが足りません！");
      } else {
        firebase
          .database()
          .ref("loginuser/" + touid + "/getapt")
          .once("value", snapshot => {
            const newapt = snapshot.val();
            wp = newapt + ap;
          });

        firebase
          .database()
          .ref("loginuser/" + useruid)
          .update({
            apt: np
          });

        firebase
          .database()
          .ref("loginuser/" + touid)
          .update({
            getapt: wp
          });

        firebase
          .database()
          .ref("myBoard/")
          .push({
            image: this.image,
            name: artistname,
            sendp: ap,
            to: toname,
            messege: toname + "に" + '<i class="far fa-thumbs-up"></i>' + ap
          });
      }
    },

    sendMessage4() {
      var artistname = this.name;
      var useruid = firebase.auth().currentUser.uid;
      var toname = this.selected["name"];
      var touid = this.selected["uid"];
      var ap = 1;
      var np = 0;
      var wp = 0;
      var takeap = 0;
      var giveap = 0;

      firebase
        .database()
        .ref("loginuser/" + useruid + "/apt")
        .once("value", snapshot => {
          const nowapt = snapshot.val();
          np = nowapt - ap;
        });
      if (np < 0) {
        alert("ポイントがなくなりました！");
        this.isButtonDisabled1 = true;
        this.isButtonDisabled2 = true;
        this.isButtonDisabled3 = true;
        this.isButtonDisabled4 = true;
      } else {
        firebase
          .database()
          .ref("loginuser/" + touid + "/getapt")
          .once("value", snapshot => {
            const newapt = snapshot.val();
            wp = newapt + ap;
          });

        firebase
          .database()
          .ref("loginuser/" + useruid)
          .update({
            apt: np
          });

        firebase
          .database()
          .ref("loginuser/" + touid)
          .update({
            getapt: wp
          });

        firebase
          .database()
          .ref("myBoard/")
          .push({
            image: this.image,
            name: artistname,
            sendp: ap,
            to: toname,
            messege: toname + "に" + '<i class="far fa-thumbs-up"></i>' + ap
          });
      }
    },

    sendMessage5() {
      var artistname = this.name;
      var messege = this.messege;
      firebase
        .database()
        .ref("myBoard/")
        .push({
          image: this.image,
          name: artistname,
          messege: messege
        });
      this.messege = "";
    }
  }
};

window.addEventListener(
  "beforeunload",
  function(e) {
    e.returnValue = "閉じますか？";
    firebase
      .auth()
      .signOut()
      .then(() => {
        this.$router.push("/signin");
      });
  },
  false
);
</script>

<style src="vue-multiselect/dist/vue-multiselect.min.css"></style>

<style>
.item-image img {
  border-radius: 50%;
  vertical-align: top;
  border: solid 2px rgb(245, 245, 232);
}

iframe {
  width: 100%;
  max-width: 650px; /* Also helpful. Optional. */
}

.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.5s;
}
.fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
  opacity: 0;
}
</style>